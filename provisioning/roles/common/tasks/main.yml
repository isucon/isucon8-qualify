---
- name: Create isucon group
  become: yes
  become_user: root
  group:
    name: isucon
    gid: 1001
    state: present
    system: no

- name: Create isucon user
  become: yes
  become_user: root
  user:
    name: isucon
    uid: 1001
    group: isucon
    password: isucon
    home: /home/isucon
    shell: /bin/bash
    state: present
    system: no

- name: Add sudoers
  become: yes
  become_user: root
  copy:
    content: "isucon  ALL=(ALL) NOPASSWD:ALL\n"
    dest: /etc/sudoers.d/90-isucon-user
    owner: root
    group: root
    mode: 0440

- name: Install epel-release
  become: yes
  become_user: root
  yum:
    pkg: "{{ item }}"
    state: installed
  with_items:
    - epel-release

- name: Install Development Tools
  become: yes
  become_user: root
  yum: name="{{ item }}" state=present
  with_items:
    - "@Development Tools"

- name: Install packages
  become: yes
  become_user: root
  yum:
    pkg: "{{ item }}"
    state: installed
  with_items:
    - autoconf
    - automake
    - curl
    - dstat
    - firewalld
    - gdbm-devel
    - git
    - jq
    - libffi-devel
    - libyaml-devel
    - ncurses-devel
    - openssl-devel
    - patch
    - readline-devel
    - sudo
    - zlib-devel
    - vim

- name: Restart and enable firewalld
  become: yes
  become_user: root
  systemd:
    name: firewalld
    state: restarted
    daemon_reload: yes
    enabled: yes

- name: Install anyenv
  become: yes
  become_user: isucon
  git:
    repo: https://github.com/anyenv/anyenv.git
    dest: /home/isucon/.anyenv
    version: master

- name: Install anyenv plugins
  become: yes
  become_user: isucon
  git:
    repo: https://github.com/yakult1995/isucon8-qualify.git
    dest: /home/isucon/.anyenv/anyenv-update

- name: Install goenv
  become: yes
  become_user: isucon
  shell:
    "anyenv install -s goenv"
  environment:
     PATH: "/home/isucon/.anyenv/bin:{{ lookup('env', 'PATH') }}"
